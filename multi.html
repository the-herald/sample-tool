<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PPC Gadget — RSA Builder (Multi)</title>
<link rel="icon" href="/favicon.png" />
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b0e13;color:#e8ecf3}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  textarea,input{width:100%;padding:10px;border:1px solid #202635;border-radius:10px;background:#121621;color:#e8ecf3}
  label{font-size:12px;color:#9aa3b7}
  .btn{padding:10px 14px;border:1px solid #202635;border-radius:10px;background:#121621;color:#e8ecf3;cursor:pointer}
  .row{margin-bottom:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  a.btn{display:inline-block;text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>RSA Builder (Multi)</h1>

  <div class="row">
    <label>Bulk Ad Copy (your format: Title:, Search:, Domain:, Paths:, Heads:, Descs:, Callouts:, Snip1:, Snip2:, ...)</label>
    <textarea id="bulk" rows="24" placeholder="Paste your blocks here..."></textarea>
  </div>

  <div class="row">
    <button id="share" class="btn">Open Preview</button>
    <a id="previewLink" class="btn" href="#" target="_blank" rel="noopener">Preview Link</a>
  </div>

  <div class="row">
    <label>Hash (debug)</label>
    <div class="mono" id="hash" style="word-break:break-all"></div>
  </div>
</div>

<script>
/* LZString (URI-safe; same as index/preview) */
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},e={compressToEncodedURIComponent:function(o){return null==o?"":e._compress(o,6,function(o){return n.charAt(o)})},_compress:function(o,n,t){if(null==o)return"";var e,i,s={},p={},a="",u="",c="",f=2,l=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(a=o.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=l++,p[a]=!0),u=c+a,Object.prototype.hasOwnProperty.call(s,u))c=u;else{if(Object.prototype.hasOwnProperty.call(p,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++;}else{for(i=1,e=0;e<h;e++)m=m<<1|i,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++;}f--,0==f&&(f=Math.pow(2,h),h++),delete p[c]}else{for(i=s[c],e=0;e<h;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++}f--,0==f&&(f=Math.pow(2,h),h++),s[u]=l++,c=String(a)}if(""!==c){if(Object.prototype.hasOwnProperty.call(p,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++;}else{for(i=1,e=0;e<h;e++)m=m<<1|i,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(i=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++;}f--,0==f&&(f=Math.pow(2,h),h++),delete p[c]}else{for(i=s[c],e=0;e<h;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++}f--,0==f&&(f=Math.pow(2,h),h++),i=2;for(e=0;e<h;e++)m=m<<1|1&i,v==n-1?(v=0,d.push(t(m)),m=0):v++;for(;;){if(m<<=1,v==n-1){d.push(t(m));break}v++}return d.join("")},};return e}();

/* helpers */
const $ = s => document.querySelector(s);
const trim = s => (s||'').trim();
const lines = v => (v||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);

// parse a single block in your “Title:/Search:/Domain:/Paths:/Heads:/Descs:/Callouts:/SnipX:” format
function parseBlock(txt){
  const o = { title:'', q:'', dm:'', u:'', p1:'', p2:'', h:[], d:[], c:[], msv:[] };
  const get = (label) => {
    const m = txt.match(new RegExp(`^${label}\\s*:\\s*([\\s\\S]*?)(?:\\n[A-Z][^:\\n]*:|$)`,'mi'));
    return m ? m[1].trim() : '';
  };

  o.title = get('Title');
  o.q     = get('Search');

  // Domain & URL
  o.dm    = get('Domain').replace(/^https?:\\/\\//,'').replace(/^www\\./,'');
  const pathsRaw = get('Paths'); // "one | two"
  if (pathsRaw.includes('|')){
    const [a,b] = pathsRaw.split('|').map(s=>s.trim());
    o.p1=a||''; o.p2=b||'';
  } else if (pathsRaw){
    o.p1 = pathsRaw.trim();
  }

  // Headlines
  const headsRaw = get('Heads');
  if (headsRaw) o.h = lines(headsRaw);

  // Descriptions
  const descsRaw = get('Descs');
  if (descsRaw) o.d = lines(descsRaw);

  // Callouts
  const callsRaw = get('Callouts');
  if (callsRaw) o.c = lines(callsRaw);

  // Snippet sets Snip1..Snip4
  for (let i=1;i<=4;i++){
    const hdr = get(`Snip${i}`);
    if (!hdr) continue;
    const values = lines(hdr).slice(0); // first line is header, following lines are values
    if (!values.length) continue;
    const header = values.shift(); // treat first line as header, rest as values
    o.msv.push({ h: header, v: values });
  }

  // Landing page: allow either explicit "URL:" or infer from Domain (optional)
  const u = get('URL');
  if (u) o.u = u;

  return o;
}

function splitBlocks(raw){
  // blocks separated by a line with only '---' or blank lines between "Title:" sections
  const parts = raw.split(/\n-{3,}\n|(?=^Title\s*:)/gmi).map(s=>s.trim()).filter(Boolean);
  return parts;
}

function buildPayload(){
  const blocks = splitBlocks($('#bulk').value);
  const ads = blocks.map(parseBlock).filter(a=>a.h.length || a.d.length);

  // keep top-level theme if you use themes later (optional)
  const payload = { theme:'dark', ads };
  return payload;
}

function makeLink(){
  const payload = buildPayload();
  const json = JSON.stringify(payload);
  const hash = LZString.compressToEncodedURIComponent(json);
  const url = `./preview.html#${hash}`;
  $('#hash').textContent = hash;
  $('#previewLink').href = url;
  return url;
}

document.getElementById('share').onclick = ()=>{ window.open(makeLink(), '_blank'); };
</script>
</body>
</html>
