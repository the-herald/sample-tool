<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PPC Gadget — Ad Preview</title>
<link rel="icon" href="/favicon.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b0e13; --panel:#121621; --line:#202635; --text:#e8ecf3; --muted:#9aa3b7; --brand:#6DBE45; }
  [data-theme="light"]{ --bg:#f6f7fb; --panel:#ffffff; --line:#e7e9f2; --text:#0f1422; --muted:#56607a; --brand:#2f8d19; }
  [data-theme="cyberpunk"]{ --bg:#0a0c12; --panel:#0e1220; --line:#23283b; --text:#e6f7ff; --muted:#7bd4ff; --brand:#ff2bd6; }

  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:28px;height:28px}
  h1{margin:0;font-size:18px}
  .a{color:var(--brand);text-decoration:none}
  .btn{border:1px solid var(--line);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted);margin-left:6px}
  .topbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .adpicker{display:flex;gap:8px;flex-wrap:wrap}
  .chipBtn{border:1px solid var(--line);background:var(--panel);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
  .chipBtn.active{outline:2px solid var(--brand)}
  .input{border:1px solid var(--line);background:var(--panel);color:var(--text);padding:8px 10px;border-radius:10px;min-width:260px}

  /* SERP */
  .grid {display:grid;grid-template-columns:1fr 380px;gap:14px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  .serp{
    background:#fff; color:#202124;
    border:1px solid #e3e6ef; border-radius:12px;
    padding:14px; font-family: Roboto, Arial, sans-serif;
  }
  .serp .sponsored{font-size:12px;color:#5f6368;margin-bottom:6px}
  .serp .result{position:relative;padding-left:40px}
  .serp .favicon{position:absolute; left:0; top:2px; width:28px; height:28px; border-radius:6px; background:#1a73e8}
  .serp .site{font-size:12px;color:#5f6368;line-height:1.2}
  .serp .path{font-size:12px;color:#137333;margin-top:1px}
  .serp .title{display:inline-block;color:#1a0dab;font-size:20px;line-height:1.3;margin:6px 0 4px;text-decoration:none}
  .serp .title:hover{text-decoration:underline}
  .serp .desc{font-size:14px;color:#4d5156;line-height:1.5}
  .serp .sl{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;margin-top:10px}
  .serp .sl a{color:#1a0dab;font-size:13px;text-decoration:none}
  .serp .sl a:hover{text-decoration:underline}

  /* Mobile frame (no orange) */
  .frame{background:#fff;border:10px solid #e7eaef;border-radius:24px}

  /* Details block */
  .drawer{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin-top:16px;overflow:hidden}
  .drawer summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:600;border-bottom:1px solid var(--line)}
  .drawer summary::-webkit-details-marker{display:none}
  .drawer .inner{padding:12px 14px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="/logo.png" alt="PPC Gadget">
      <h1>Ad Preview</h1>
      <span id="themePill" class="pill"></span>
    </div>
    <div class="topbar">
      <div id="adPicker" class="adpicker"></div>
      <input id="domainInput" class="input" placeholder="Domain override (e.g., hammockisland.com)" />
      <button id="cycleSnipBtn" class="btn" style="display:none">Cycle Snippet Set</button>
      <button id="switchImgBtn" class="btn" style="display:none">Switch Image</button>
      <a id="backLink" class="a btn" href="#">Open in Builder</a>
    </div>
  </header>

  <section>
    <div class="grid">
      <!-- Desktop SERP -->
      <article class="serp" aria-label="Desktop Ad">
        <div class="sponsored">Sponsored</div>
        <div class="result">
          <div class="favicon" aria-hidden="true"></div>
          <div class="site" id="siteDesk">example.com</div>
          <div class="path"><span id="domainDesk">example.com</span>/<span id="pPath1"></span><span id="pSlash1"></span><span id="pPath2"></span></div>
          <a href="javascript:void(0)" class="title" id="pTitle">Your Business - example.com</a>
          <div class="desc" id="descDesk"></div>
          <div class="sl" id="pSLDesk"></div>
        </div>
      </article>

      <!-- Mobile SERP -->
      <div class="frame">
        <article class="serp" style="border:none" aria-label="Mobile Ad">
          <div class="sponsored">Sponsored</div>
          <div class="result">
            <div class="favicon" aria-hidden="true"></div>
            <div class="site" id="siteMob">example.com</div>
            <div class="path"><span id="domainMob">example.com</span>/<span id="pPath1M"></span><span id="pSlash1M"></span><span id="pPath2M"></span></div>
            <a href="javascript:void(0)" class="title" id="pTitleM">Your Business - example.com</a>
            <div class="desc" id="descMob"></div>
            <div class="sl" id="pSLMob"></div>
          </div>
        </article>
      </div>
    </div>
  </section>

  <details class="drawer" open>
    <summary>Full Ad Copy</summary>
    <div class="inner grid2">
      <div>
        <h3 style="margin:0 0 8px">Headlines</h3>
        <ul id="dHeads"></ul>
        <h3 style="margin:12px 0 8px">Descriptions</h3>
        <ul id="dDescs"></ul>
        <h3 style="margin:12px 0 8px">Callouts</h3>
        <ul id="dCalls"></ul>
        <h3 style="margin:12px 0 8px">Structured Snippets</h3>
        <div id="dSnips"></div>
        <h3 style="margin:12px 0 8px">Display Paths</h3>
        <div class="mono">/<span id="dPath1"></span><span id="dSlash1"></span><span id="dPath2"></span></div>
        <h3 style="margin:12px 0 8px">Search Query</h3>
        <div class="mono" id="dQ"></div>
        <h3 style="margin:12px 0 8px">Domain</h3>
        <div class="mono" id="dDomain"></div>
        <h3 style="margin:12px 0 8px">Landing Page</h3>
        <div class="mono" id="dURL"></div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">Images</h3>
        <ul id="dImgs"></ul>
      </div>
    </div>
  </details>
</div>

<script>
/* ===== helpers & payload ===== */
const $  = id => document.getElementById(id);
const dec= s => JSON.parse(decodeURIComponent(escape(atob(s))));
const esc= t => (t||'').replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));

let P=null, isMulti=false, idx=0, snipIdx=0, imgIdx=0;
let overrideDomain='';

function pickBuilderUrl(){ return isMulti ? './multi.html' : './index.html'; }
function topHeads(ad){ return (ad.h||[]).slice(0,3).map(x=>x.t||x); }
function getDomainFromURL(u){
  try{ const h=new URL(u).hostname; return h.replace(/^www\./,''); }catch(e){ return ''; }
}
function resolveDomain(ad){
  if (overrideDomain) return overrideDomain;
  const candidates = [
    ad.domain, ad.displayDomain, ad.host, ad.dm,
    P?.domain, P?.displayDomain, P?.host, P?.dm
  ].filter(Boolean);
  for (const c of candidates){
    const d = String(c).trim().replace(/^https?:\/\//,'').replace(/^www\./,'');
    if (d) return d;
  }
  const fromUrl = getDomainFromURL(ad.u || P?.u || '');
  return fromUrl || 'example.com';
}

/* ===== UI for multi payloads ===== */
function renderPicker(){
  const wrap=$('adPicker'); wrap.innerHTML='';
  if(!isMulti){ $('cycleSnipBtn').style.display='none'; $('switchImgBtn').style.display='none'; return; }
  $('cycleSnipBtn').style.display='inline-block';
  $('switchImgBtn').style.display='inline-block';
  (P.ads||[]).forEach((ad,i)=>{
    const b=document.createElement('button');
    b.className='chipBtn'+(i===idx?' active':'');
    b.textContent=ad.title?ad.title:`Ad ${i+1}`;
    b.onclick=()=>{ idx=i; snipIdx=0; imgIdx=0; render(); renderPicker(); };
    wrap.appendChild(b);
  });
}

/* ===== SERP rendering ===== */
function render(){
  if(!P) return;
  document.documentElement.setAttribute('data-theme', P.theme || 'dark');
  $('themePill').textContent = (P.theme||'dark');
  $('backLink').href = `${pickBuilderUrl()}${location.hash}`;

  // choose ad
  let ad = isMulti ? ((P.ads||[])[idx]||{}) :
            { q:P.q||'', p1:P.p1||'', p2:P.p2||'',
              h:(P.h||[]).map(x=>x.t||x), d:P.d||[], c:P.c||[],
              msv:P.msv||[], sv:P.sv||[], sh:P.sh||'Services',
              sl:P.sl||[], u:P.u||'', domain:P.domain||'', imgs:P.imgs||[] };

  const domain = resolveDomain(ad);

  // paths + site lines
  $('siteDesk').textContent = domain;
  $('siteMob').textContent  = domain;
  $('domainDesk').textContent = domain;
  $('domainMob').textContent  = domain;

  $('pPath1').textContent = ad.p1||''; $('pPath2').textContent = ad.p2||'';
  $('pSlash1').textContent = (ad.p1 && ad.p2)?'/':'';
  $('pPath1M').textContent = ad.p1||''; $('pPath2M').textContent = ad.p2||'';
  $('pSlash1M').textContent = (ad.p1 && ad.p2)?'/':'';

  // title from first 3 heads (Google/Karooya style)
  const H = topHeads(ad);
  const title = H.length ? H.join(' | ') : 'Add a headline…';
  $('pTitle').textContent = title;
  $('pTitleM').textContent = title;

  // ----- SINGLE PARAGRAPH: Descriptions + Callouts + Snippet -----
  const D1=(ad.d||[])[0]||'', D2=(ad.d||[])[1]||'';
  const descTxt = D2 ? `${D1} ${D2}` : D1;

  // callouts (max 4)
  const calls = (ad.c||[]).slice(0,4);
  const callsTxt = calls.length ? ` ${calls.join(' \u00B7 ')}` : '';

  // structured snippet: prefer msv[0], else sv with header; max 4 values
  let snHead='', snVals=[];
  if (Array.isArray(ad.msv) && ad.msv.length){
    snHead = ad.msv[0]?.header || 'Services';
    snVals = (ad.msv[0]?.values || []).slice(0,4);
  } else if ((ad.sv||[]).length){
    snHead = ad.sh || 'Services';
    snVals = (ad.sv||[]).slice(0,4);
  }
  const SEP = ' \u00B7 ';
  const snipTxt = snVals.length ? ` — ${snHead}: ${snVals.join(SEP)}` : '';

  const fullPara = `${descTxt}${callsTxt}${snipTxt}`;
  $('descDesk').textContent = fullPara;
  $('descMob').textContent  = fullPara;

  // sitelinks (if any)
  function drawSL(el){
    el.innerHTML='';
    (ad.sl||[]).slice(0,4).forEach(sl=>{
      const a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=sl.t||''; el.appendChild(a);
    });
  }
  drawSL($('pSLDesk')); drawSL($('pSLMob'));

  /* ---- Full details panel: show EVERYTHING for the selected ad ---- */
  const UL=(id,arr,fmt=x=>esc(x))=>{ const el=$(id); el.innerHTML=''; (arr||[]).forEach(v=>{ const li=document.createElement('li'); li.innerHTML=fmt(v); el.appendChild(li); }); };
  UL('dHeads', ad.h||H, h=>`<span class="mono">${esc(h)}</span>`);
  UL('dDescs', ad.d||[], d=>`<span class="mono">${esc(d)}</span>`);
  UL('dCalls', ad.c||[], c=>`<span class="mono">${esc(c)}</span>`);

  const dSnips=$('dSnips'); dSnips.innerHTML='';
  if (Array.isArray(ad.msv) && ad.msv.length){
    ad.msv.forEach(s=>{
      const div=document.createElement('div');
      div.innerHTML = `<b>${esc(s.header||'Services')}:</b> <span class="mono">${esc((s.values||[]).join(' \u00B7 '))}</span>`;
      dSnips.appendChild(div);
    });
  } else if ((ad.sv||[]).length){
    const div=document.createElement('div');
    div.innerHTML = `<b>${esc(ad.sh||'Services')}:</b> <span class="mono">${esc((ad.sv||[]).join(' \u00B7 '))}</span>`;
    dSnips.appendChild(div);
  }

  $('dPath1').textContent = ad.p1||''; $('dPath2').textContent= ad.p2||''; $('dSlash1').textContent=(ad.p1&&ad.p2)?'/':'';
  $('dQ').textContent = ad.q || '';
  $('dDomain').textContent = domain;
  $('dURL').textContent = ad.u || '';
  UL('dImgs', ad.imgs||[], u=>`<span class="mono">${esc(u)}</span>`);
}

/* ===== init & controls ===== */
(function init(){
  try{ P = dec(location.hash.slice(1)); }catch(e){ P = {}; }
  isMulti = !!P.ads;
  idx = P.idx || 0;
  snipIdx = P.snip || 0;
  imgIdx  = P.img || 0;

  renderPicker();
  render();

  $('cycleSnipBtn').onclick = ()=>{ snipIdx=(snipIdx+1)%4; render(); };
  $('switchImgBtn').onclick = ()=>{ imgIdx+=1; render(); };
  $('domainInput').addEventListener('input', e => {
    overrideDomain = (e.target.value||'').trim().replace(/^https?:\/\//,'').replace(/^www\./,'');
    render();
  });
})();
</script>
</body>
</html>
